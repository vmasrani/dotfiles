#!/usr/bin/env zsh
# Sync mail and give notification if there is new mail
# Modernized for macOS (2026), originally by Luke Smith

# notmuch config path
export NOTMUCH_CONFIG="$HOME/.config/notmuch/notmuchrc"

# Run only if user logged in
pgrep -u "${USER:=$LOGNAME}" >/dev/null || { echo "$USER not logged in; sync will not run."; exit; }

# Run only if not already running in another instance
pgrep -x mbsync >/dev/null && { echo "mbsync is already running."; exit; }

# Check for internet connection
ping -q -c 1 1.1.1.1 > /dev/null 2>&1 || { echo "No internet connection detected."; exit; }

# macOS notification function (set MAILSYNC_NOTIFY=1 to enable)
notify() {
    [[ "$MAILSYNC_NOTIFY" == "1" ]] && osascript -e "display notification \"$2 new mail(s) in $1\" with title \"You've got Mail\" sound name \"Glass\""
    return 0
}

messageinfo() {
    [[ "$MAILSYNC_NOTIFY" == "1" ]] && osascript -e "display notification \"$subject\" with title \"$from\""
    return 0
}

# Check account for new mail and notify
syncandnotify() {
    acc="$(echo "$account" | sed "s/.*\///")"
    mbsync -c "$HOME/.config/isync/mbsyncrc" $opts "$acc"

    new=$(find "$HOME/.local/share/mail/$acc/INBOX/new/" \
               "$HOME/.local/share/mail/$acc/Inbox/new/" \
               "$HOME/.local/share/mail/$acc/inbox/new/" \
               -type f -newer "$HOME/.config/mutt/.mailsynclastrun" 2>/dev/null)

    newcount=$(echo "$new" | sed '/^\s*$/d' | wc -l | tr -d ' ')

    if [[ "$newcount" -gt "0" ]]; then
        notify "$acc" "$newcount" &
        for file in $new; do
            # Extract subject and sender from mail
            from=$(awk '/^From: / && ++n ==1,/^\<.*\>:/' "$file" | \
                   perl -CS -MEncode -ne 'print decode("MIME-Header", $_)' | \
                   awk '{ $1=""; if (NF>=3)$NF=""; print $0 }' | \
                   sed 's/^[[:blank:]]*[\"'\''\<]*//;s/[\"'\''\>]*[[:blank:]]*$//')
            subject=$(awk '/^Subject: / && ++n == 1,/^\<.*\>: / && ++i == 2' "$file" | \
                      head -n 1 | \
                      perl -CS -MEncode -ne 'print decode("MIME-Header", $_)' | \
                      sed 's/^Subject: //' | \
                      sed 's/^{[[:blank:]]*[\"'\''\<]*//;s/[\"'\''\>]*[[:blank:]]*$//' | \
                      tr -d '\n')
            messageinfo &
        done
    fi
}

# Sync accounts passed as argument or all
if [[ "$#" -eq "0" ]]; then
    accounts="$(awk '/^Channel/ {print $2}' "$HOME/.config/isync/mbsyncrc")"
else
    for arg in "$@"; do
        [[ "${arg%${arg#?}}" = '-' ]] && opts="${opts:+${opts} }${arg}" && shift 1
    done
    accounts=$*
fi

# Parallelize multiple accounts
for account in $accounts; do
    syncandnotify &
done

wait

# Index new mail with notmuch
notmuch new 2>/dev/null

# Tag all "new" messages as "inbox" and "unread"
notmuch tag +inbox +unread -new -- tag:new

# Tag messages from self as sent (add your email addresses here)
source "$HOME/.mutt_secrets" 2>/dev/null
if [[ -n "$my_gmail_user" ]]; then
    notmuch tag -new -inbox +sent -- from:"$my_gmail_user"
fi

# Create touch file indicating last sync time
touch "$HOME/.config/mutt/.mailsynclastrun"
