#!/bin/zsh
# ===================================================================
# AWS EC2 Instance Management Script - Stop Instance
# ===================================================================
# Manages EC2 instance shutdown with volume detachment
# Usage: ./stop_aws
# ===================================================================

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/aws_common.sh"

# Select instance
select_instance "AWS EC2 Instance Shutdown" 196

# Check instance state
INSTANCE_STATE=$(get_instance_state "$INSTANCE_ID")

# Stop instance if running
if [[ "$INSTANCE_STATE" = "stopped" ]]; then
    gum style --foreground 46 "✓ Instance is already stopped"
elif [[ "$INSTANCE_STATE" = "running" ]]; then
    if gum confirm "Stop instance $INSTANCE_ID?"; then
        gum style --foreground 208 "→ Stopping instance..."
        aws ec2 stop-instances --instance-ids "$INSTANCE_ID" --no-cli-pager > /dev/null
        wait_for_instance_stopped "$INSTANCE_ID"
        gum style --foreground 46 "✓ Instance stopped"
    else
        gum style --foreground 196 "✗ Cancelled"
        exit 0
    fi
else
    gum style --foreground 208 "⚠ Instance is in state: $INSTANCE_STATE. Waiting for it to stop..."
    wait_for_instance_stopped "$INSTANCE_ID"
    gum style --foreground 46 "✓ Instance stopped"
fi

# Optional volume detachment
if gum confirm "Detach volume $VOLUME_ID?"; then
    gum style --foreground 208 "→ Detaching volume..."
    aws ec2 detach-volume \
        --volume-id "$VOLUME_ID" \
        --instance-id "$INSTANCE_ID" \
        --device "$DEVICE_NAME" --no-cli-pager > /dev/null 2>&1 || true

    wait_for_volume_available "$VOLUME_ID"
    gum style --foreground 46 "✓ Volume detached and available"
else
    gum style --foreground 208 "→ Skipping volume detachment"
fi

gum style --border rounded --padding "0 2" --border-foreground 46 --foreground 46 "Shutdown complete"
