#!/bin/zsh
# ===================================================================
# AWS EC2 Instance Management Script - Stop Instance
# ===================================================================
# Manages EC2 instance shutdown with volume detachment
# Usage: ./stop_aws
# ===================================================================

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/aws_common.sh"

# Select instance
select_instance "AWS EC2 Instance Shutdown" 196

# Check instance state
INSTANCE_STATE=$(get_instance_state "$INSTANCE_ID")

# Stop instance if running
if [[ "$INSTANCE_STATE" = "stopped" ]]; then
    gum_success "Instance is already stopped"
elif [[ "$INSTANCE_STATE" = "running" ]]; then
    if gum_confirm "Stop instance $INSTANCE_ID?"; then
        gum_info "Stopping instance..."
        aws ec2 stop-instances --instance-ids "$INSTANCE_ID" --no-cli-pager > /dev/null
        wait_for_instance_stopped "$INSTANCE_ID"
        gum_success "Instance stopped"
    else
        gum_error "Cancelled"
        exit 0
    fi
else
    gum_warning "Instance is in state: $INSTANCE_STATE. Waiting for it to stop..."
    wait_for_instance_stopped "$INSTANCE_ID"
    gum_success "Instance stopped"
fi

# Optional volume detachment
if gum_confirm "Detach volume $VOLUME_ID?"; then
    gum_info "Detaching volume..."
    aws ec2 detach-volume \
        --volume-id "$VOLUME_ID" \
        --instance-id "$INSTANCE_ID" \
        --device "$DEVICE_NAME" --no-cli-pager > /dev/null 2>&1 || true

    wait_for_volume_available "$VOLUME_ID"
    gum_success "Volume detached and available"
else
    gum_info "Skipping volume detachment"
fi

gum_box_success "Shutdown complete"
