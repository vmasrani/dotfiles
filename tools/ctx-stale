#!/usr/bin/env zsh
# Find directories with missing or stale *-context.md files.
# A context file is "stale" if any sibling file is newer than it.
# Usage: ctx-stale [directory] [--max-depth N] [--min-files N]
#   directory:   root to scan (default: .)
#   --max-depth: how deep to scan (default: 4)
#   --min-files: skip dirs with fewer non-context files (default: 2)

set -e

source "${HOME}/dotfiles/shell/gum_utils.sh" 2>/dev/null || true

dir="."
max_depth=4
min_files=2

while [[ $# -gt 0 ]]; do
    case "$1" in
        --max-depth) max_depth="$2"; shift 2 ;;
        --min-files) min_files="$2"; shift 2 ;;
        *) dir="$1"; shift ;;
    esac
done

dir="${dir:A}"

skip_dirs=('.git' '.venv' '.vscode' '.cursor' '.claude' 'node_modules' '__pycache__' 'dist' 'build' '.next' '.mypy_cache' '.pytest_cache' '.tox' 'egg-info' 'tmp')

should_skip() {
    local d="$1"
    for skip in "${skip_dirs[@]}"; do
        [[ "$d" == *"/${skip}/"* || "$d" == *"/${skip}" ]] && return 0
    done
    return 1
}

missing=()
stale=()
fresh=()
skipped_small=0

# Find all directories (non-hidden, depth-limited)
dirs=("${(@f)$(fd --type d --max-depth "$max_depth" '' "$dir" 2>/dev/null)}")
# Include root
dirs=("$dir" "${dirs[@]}")

for d in "${dirs[@]}"; do
    [[ -z "$d" ]] && continue
    should_skip "$d" && continue

    dirname="${d:t}"
    [[ -z "$dirname" || "$dirname" == "." ]] && dirname="${dir:t}"
    ctx_file="$d/${dirname}-context.md"

    # Count non-context files in directory
    file_count=$(fd --no-ignore --max-depth 1 --type f --exclude '*-context.md' '' "$d" 2>/dev/null | wc -l | tr -d ' ')

    # Skip directories with too few files
    if [[ "$file_count" -lt "$min_files" ]]; then
        skipped_small=$((skipped_small + 1))
        continue
    fi

    if [[ ! -f "$ctx_file" ]]; then
        missing+=("$d")
    else
        # Check if any sibling is newer than the context file
        ctx_mtime=$(stat -f '%m' "$ctx_file" 2>/dev/null || stat -c '%Y' "$ctx_file" 2>/dev/null)
        is_stale=false
        while IFS= read -r sibling; do
            [[ -z "$sibling" ]] && continue
            sib_mtime=$(stat -f '%m' "$sibling" 2>/dev/null || stat -c '%Y' "$sibling" 2>/dev/null)
            if [[ "$sib_mtime" -gt "$ctx_mtime" ]]; then
                is_stale=true
                break
            fi
        done < <(fd --no-ignore --max-depth 1 --type f --exclude '*-context.md' '' "$d" 2>/dev/null)
        if $is_stale; then
            stale+=("$d")
        else
            fresh+=("$d")
        fi
    fi
done

if [[ ${#missing[@]} -gt 0 ]]; then
    echo "MISSING (${#missing[@]}):"
    printf '  %s\n' "${missing[@]}"
    echo ""
fi

if [[ ${#stale[@]} -gt 0 ]]; then
    echo "STALE (${#stale[@]}):"
    printf '  %s\n' "${stale[@]}"
    echo ""
fi

echo "FRESH (${#fresh[@]}): up-to-date, no action needed"
if [[ "$skipped_small" -gt 0 ]]; then
    gum_dim "Skipped $skipped_small dirs with <$min_files files" 2>/dev/null || echo "Skipped $skipped_small dirs with <$min_files files"
fi
echo ""
echo "Total: ${#missing[@]} missing, ${#stale[@]} stale, ${#fresh[@]} fresh"
