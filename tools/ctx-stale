#!/usr/bin/env zsh
# Find directories with missing or stale *-context.md files.
# A context file is "stale" if any sibling file is newer than it.
# Usage: ctx-stale [directory]
#   directory: root to scan (default: .)

set -e

dir="${1:-.}"

skip_dirs=('.git' '.venv' '.vscode' '.cursor' '.claude' 'node_modules' '__pycache__' 'dist' 'build' '.next' '.mypy_cache' '.pytest_cache' '.tox' 'egg-info' 'tmp')

should_skip() {
    local d="$1"
    for skip in "${skip_dirs[@]}"; do
        [[ "$d" == *"/${skip}/"* || "$d" == *"/${skip}" ]] && return 0
    done
    return 1
}

missing=()
stale=()
fresh=()

# Find all directories (non-hidden, depth-limited)
dirs=("${(@f)$(fd --type d --max-depth 4 '' "$dir" 2>/dev/null)}")
# Include root
dirs=("$dir" "${dirs[@]}")

for d in "${dirs[@]}"; do
    [[ -z "$d" ]] && continue
    should_skip "$d" && continue

    dirname="${d:t}"
    [[ -z "$dirname" || "$dirname" == "." ]] && dirname="${dir:t}"
    ctx_file="$d/${dirname}-context.md"

    if [[ ! -f "$ctx_file" ]]; then
        # Check if directory has any non-context files worth documenting
        file_count=$(fd --no-ignore --max-depth 1 --type f --exclude '*-context.md' '' "$d" 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$file_count" -gt 0 ]]; then
            missing+=("$d")
        fi
    else
        # Check if any sibling is newer than the context file
        ctx_mtime=$(stat -f '%m' "$ctx_file" 2>/dev/null || stat -c '%Y' "$ctx_file" 2>/dev/null)
        is_stale=false
        while IFS= read -r sibling; do
            [[ -z "$sibling" ]] && continue
            sib_mtime=$(stat -f '%m' "$sibling" 2>/dev/null || stat -c '%Y' "$sibling" 2>/dev/null)
            if [[ "$sib_mtime" -gt "$ctx_mtime" ]]; then
                is_stale=true
                break
            fi
        done < <(fd --no-ignore --max-depth 1 --type f --exclude '*-context.md' '' "$d" 2>/dev/null)
        if $is_stale; then
            stale+=("$d")
        else
            fresh+=("$d")
        fi
    fi
done

if [[ ${#missing[@]} -gt 0 ]]; then
    echo "MISSING (${#missing[@]}):"
    printf '  %s\n' "${missing[@]}"
    echo ""
fi

if [[ ${#stale[@]} -gt 0 ]]; then
    echo "STALE (${#stale[@]}):"
    printf '  %s\n' "${stale[@]}"
    echo ""
fi

echo "FRESH (${#fresh[@]}): up-to-date, no action needed"
echo ""
echo "Total: ${#missing[@]} missing, ${#stale[@]} stale, ${#fresh[@]} fresh"
