#!/bin/zsh

# Convert to PDF if needed, then rename the PDF
# Usage: rename_and_convert <input.epub|.mobi|.pdf>

set -euo pipefail

export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"
TOOLS_DIR="/Users/vmasrani/dotfiles/tools"

input="${1:-}"

if [[ -z "$input" ]]; then
  echo "Usage: $0 <input.epub|.mobi|.pdf>" >&2
  exit 1
fi

if [[ ! -f "$input" ]]; then
  echo "Error: File '$input' not found" >&2
  exit 1
fi

ext="${input##*.}"
ext_lc="${ext:l}"

case "$ext_lc" in
  epub|mobi)
    pdf_path=$("$TOOLS_DIR"/convert_ebook "$input" | tail -n1)
    input="$pdf_path"
    ;;
  pdf)
    ;;
  *)
    echo "Error: Unsupported extension '.$ext_lc'. Use .epub, .mobi, or .pdf" >&2
    exit 1
    ;;
esac

renamed_pdf=$("$TOOLS_DIR"/rename_pdf "$input")
echo "$renamed_pdf"
