#!/bin/zsh
# rename_file.sh - Rename a single file using Claude AI
# Usage: ./rename_file.sh filename.pdf

file="$1"

# Check if file argument provided
if [[ -z "$file" ]]; then
    echo -e "\033[31mUsage: $0 filename\033[0m"
    exit 1
fi

# Check if file exists
if [[ ! -f "$file" ]]; then
    echo -e "\033[31mError: File '$file' not found\033[0m"
    exit 1
fi

# Get file extension
extension="${file##*.}"

# Create prompt for Claude
system_prompt="$(cat $HOME/.claude/commands/file-renamer.md) $file."
text="$(pdf_extract_pages "$file" | markitdown)"
new_name=$(oai "$system_prompt $text")

# Check if we got a valid response
if [[ -z "$new_name" ]]; then
    echo -e "\033[31mError: Could not generate new filename for $file\033[0m"
    exit 1
fi

if [[ ${#new_name} -gt 100 ]]; then
    echo -e "\033[31mError: Generated filename is longer than 100 characters\033[0m"
    exit 1
fi

# Rename the file in-place (same directory)
dir="${file:h}"
new_filename="${dir}/${new_name}.${extension}"
mv -if -- "$file" "$new_filename"

# Remove red and add green after processing
tag --remove Red  "$new_filename"
tag --add Green "$new_filename"
echo "$new_filename"

